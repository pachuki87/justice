<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justice 2 - Configuración de Entorno</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .config-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .config-label {
            font-weight: bold;
            color: #495057;
        }
        .config-value {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            word-break: break-all;
        }
        .hidden {
            display: none;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Justice 2 - Configuración de Entorno</h1>
            <p>Gestión segura de variables de entorno para el frontend</p>
        </div>

        <div id="status" class="status hidden">
            <p id="status-message"></p>
        </div>

        <div id="config-display" class="hidden">
            <h2>Variables de Entorno Cargadas</h2>
            <div id="config-list"></div>
        </div>

        <div id="controls">
            <h2>Controles de Configuración</h2>
            <button class="btn" onclick="showConfig()">Mostrar Configuración</button>
            <button class="btn" onclick="validateConfig()">Validar Configuración</button>
            <button class="btn btn-danger" onclick="clearConfig()">Limpiar Configuración</button>
            <button class="btn" onclick="redirectMain()">Ir a Aplicación Principal</button>
        </div>

        <div id="validation-results" class="hidden">
            <h2>Resultados de Validación</h2>
            <div id="validation-list"></div>
        </div>
    </div>

    <!-- Meta tags para inyección segura de variables de entorno -->
    <!-- Estas etiquetas serán llenadas por el servidor en tiempo real -->
    <meta name="env-production_api_url" content="">
    <meta name="env-development_api_url" content="">
    <meta name="env-frontend_base_url" content="">
    <meta name="env-default_environment" content="">
    <meta name="env-valid_jwt_issuers" content="">

    <!-- Script de configuración -->
    <script src="components/env-config.js"></script>
    <script>
        // Funciones de la interfaz
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const messageEl = document.getElementById('status-message');
            
            statusEl.className = `status ${type}`;
            messageEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function hideStatus() {
            const statusEl = document.getElementById('status');
            statusEl.classList.add('hidden');
        }

        function showConfig() {
            if (typeof EnvConfig !== 'undefined' && EnvConfig.getStatus) {
                const status = EnvConfig.getStatus();
                const configList = document.getElementById('config-list');
                
                let html = '';
                
                // Mostrar estado general
                html += `
                    <div class="config-item">
                        <span class="config-label">Estado del Sistema:</span>
                        <span class="config-value">${status.loaded ? 'Cargado' : 'No cargado'}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Validación:</span>
                        <span class="config-value">${status.validated ? 'Válido' : 'No válido'}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Entorno Detectado:</span>
                        <span class="config-value">${status.environment}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Variables Cargadas:</span>
                        <span class="config-value">${status.variablesCount}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Manipulación Detectada:</span>
                        <span class="config-value">${status.tampered ? 'SÍ' : 'NO'}</span>
                    </div>
                `;
                
                // Mostrar variables específicas (sin valores sensibles)
                if (status.loaded) {
                    const apiUrl = EnvConfig.getApiUrl ? EnvConfig.getApiUrl() : 'No disponible';
                    const env = EnvConfig.getEnvironment ? EnvConfig.getEnvironment() : 'No disponible';
                    
                    html += `
                        <div class="config-item">
                            <span class="config-label">URL de API:</span>
                            <span class="config-value">${apiUrl}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Entorno:</span>
                            <span class="config-value">${env}</span>
                        </div>
                    `;
                }
                
                configList.innerHTML = html;
                document.getElementById('config-display').classList.remove('hidden');
                showStatus('Configuración cargada exitosamente', 'success');
            } else {
                showStatus('Sistema de configuración no disponible', 'error');
            }
        }

        function validateConfig() {
            if (typeof EnvConfig !== 'undefined' && EnvConfig.getStatus) {
                const status = EnvConfig.getStatus();
                const validationList = document.getElementById('validation-list');
                
                let html = '';
                
                // Validaciones de seguridad
                const validations = [
                    {
                        name: 'Sistema Inicializado',
                        status: status.loaded,
                        message: status.loaded ? 'Sistema cargado correctamente' : 'Sistema no inicializado'
                    },
                    {
                        name: 'Configuración Válida',
                        status: status.validated,
                        message: status.validated ? 'Validación exitosa' : 'Errores en validación'
                    },
                    {
                        name: 'Sin Manipulación',
                        status: !status.tampered,
                        message: status.tampered ? 'Detectada manipulación' : 'Configuración intacta'
                    },
                    {
                        name: 'URL de API Segura',
                        status: true, // Asumir que es segura si llegó aquí
                        message: 'URL configurada y validada'
                    }
                ];
                
                validations.forEach(validation => {
                    const statusClass = validation.status ? 'success' : 'error';
                    const statusIcon = validation.status ? '✅' : '❌';
                    
                    html += `
                        <div class="config-item">
                            <span class="config-label">${statusIcon} ${validation.name}:</span>
                            <span class="config-value">${validation.message}</span>
                        </div>
                    `;
                });
                
                validationList.innerHTML = html;
                document.getElementById('validation-results').classList.remove('hidden');
                
                const allValid = validations.every(v => v.status);
                showStatus(
                    allValid ? 'Todas las validaciones pasaron' : 'Hay problemas de seguridad',
                    allValid ? 'success' : 'warning'
                );
            } else {
                showStatus('Sistema de configuración no disponible para validación', 'error');
            }
        }

        function clearConfig() {
            if (confirm('¿Está seguro de que desea limpiar la configuración? Esto podría afectar el funcionamiento de la aplicación.')) {
                try {
                    // Limpiar localStorage
                    localStorage.removeItem('justice2_config');
                    localStorage.removeItem('justice2_env_config');
                    
                    // Recargar la página
                    window.location.reload();
                } catch (error) {
                    showStatus('Error al limpiar configuración: ' + error.message, 'error');
                }
            }
        }

        function redirectMain() {
            window.location.href = 'index.html';
        }

        // Inicialización automática
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un momento a que EnvConfig se inicialice
            setTimeout(() => {
                if (typeof EnvConfig !== 'undefined' && EnvConfig.getStatus) {
                    const status = EnvConfig.getStatus();
                    if (status.loaded && status.validated) {
                        showStatus('Sistema de configuración funcionando correctamente', 'success');
                    } else {
                        showStatus('Problemas en el sistema de configuración', 'warning');
                    }
                } else {
                    showStatus('Sistema de configuración no disponible', 'error');
                }
            }, 1000);
        });

        // Inyectar variables de entorno desde meta tags (simulación para desarrollo)
        // En producción, esto sería hecho por el servidor
        if (typeof window !== 'undefined' && !window.ENV) {
            window.ENV = {
                PRODUCTION_API_URL: document.querySelector('meta[name="env-production_api_url"]').content || '',
                DEVELOPMENT_API_URL: document.querySelector('meta[name="env-development_api_url"]').content || 'http://localhost:8000',
                FRONTEND_BASE_URL: document.querySelector('meta[name="env-frontend_base_url"]').content || 'http://localhost:3000',
                DEFAULT_ENVIRONMENT: document.querySelector('meta[name="env-default_environment"]').content || 'auto',
                VALID_JWT_ISSUERS: document.querySelector('meta[name="env-valid_jwt_issuers"]').content || 'justice2-system,http://localhost:8000'
            };
        }
    </script>
</body>
</html>